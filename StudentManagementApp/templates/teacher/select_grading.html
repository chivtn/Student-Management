{% extends 'layout/base.html' %}
{% block content %}
<div class="container py-4">
    <form method="POST">
        <div class="row g-3 mb-3">
            <div class="col-md-6">
                <label class="form-label">Ch·ªçn l·ªõp</label>
                <select name="class_id" class="form-select" required>
                    <option value="">-- Ch·ªçn l·ªõp --</option>
                    {% for c in classes %}
                    <option value="{{ c.id }}" {% if selected_class and selected_class.id == c.id %}selected{% endif %}>{{ c.name }} ({{ c.academic_year }})</option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-6">
                <label class="form-label">Ch·ªçn h·ªçc k·ª≥</label>
                <select name="semester_id" class="form-select" required>
                    <option value="">-- Ch·ªçn h·ªçc k·ª≥ --</option>
                    {% for s in semesters %}
                    <option value="{{ s.id }}" {% if selected_semester and selected_semester.id == s.id %}selected{% endif %}>{{ s.name }}</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <div class="text-end">
            <button type="submit" class="btn btn-primary">Ti·∫øp t·ª•c</button>
        </div>
    </form>

    {% if students %}
    <form method="POST">
        <input type="hidden" name="class_id" value="{{ selected_class.id }}">
        <input type="hidden" name="semester_id" value="{{ selected_semester.id }}">

        <table class="table table-bordered mt-4">
            <thead>
                <tr>
                    <th>#</th>
                    <th>H·ªçc sinh</th>
                    <th>15 ph√∫t</th>
                    <th>1 ti·∫øt</th>
                    <th>Cu·ªëi k·ª≥</th>
                    <th>Trung b√¨nh</th>
                </tr>
            </thead>
            <tbody>
                {% for s in students %}
                {% set sc = scores_map[s.id] %}
                <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ s.full_name }}</td>

                    <!-- C·ªòT 15 PH√öT -->
                    <td>
                        <div id="score15_{{ s.id }}">
                            {% for score in sc.score_15 %}
                            <div class="d-flex align-items-center gap-2 mb-1">
                                <input
                                    type="number"
                                    name="score_15_{{ s.id }}_{{ loop.index }}_{{ loop.index0 }}_fixed"
                                    value="{{ score.value }}"
                                    class="form-control score-input"
                                    step="0.1" min="0" max="10"
                                    {% if score.readonly %}readonly{% endif %}
                                >
                                {% if not score.readonly %}
                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.parentElement.remove()">√ó</button>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        {% if sc.score_15 | length < 5 %}
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addScoreInput('{{ s.id }}', '15')">+ Th√™m</button>
                        {% endif %}
                    </td>

                    <!-- C·ªòT 1 TI·∫æT -->
                    <td>
                        <div id="score1tiet_{{ s.id }}">
                            {% for score in sc.score_1tiet %}
                            <div class="d-flex align-items-center gap-2 mb-1">
                                <input
                                    type="number"
                                    name="score_1tiet_{{ s.id }}_{{ loop.index }}_{{ loop.index0 }}_fixed"
                                    value="{{ score.value }}"
                                    class="form-control score-input"
                                    step="0.1" min="0" max="10"
                                    {% if score.readonly %}readonly{% endif %}
                                >
                                {% if not score.readonly %}
                                <button type="button" class="btn btn-outline-danger btn-sm" onclick="this.parentElement.remove()">√ó</button>
                                {% endif %}
                            </div>
                            {% endfor %}
                        </div>
                        {% if sc.score_1tiet | length < 3 %}
                        <button type="button" class="btn btn-sm btn-outline-secondary" onclick="addScoreInput('{{ s.id }}', '1tiet')">+ Th√™m</button>
                        {% endif %}
                    </td>

                    <!-- C·ªòT CU·ªêI K·ª≤ -->
                    <td>
                        {% if sc.score_final %}
                        <input type="number"
                               name="score_final_{{ s.id }}"
                               value="{{ sc.score_final.value }}"
                               class="form-control score-input"
                               step="0.1" min="0" max="10"
                               {% if sc.score_final.readonly %}readonly{% endif %}>
                        {% else %}
                        <input type="number"
                               name="score_final_{{ s.id }}"
                               class="form-control score-input"
                               step="0.1" min="0" max="10">
                        {% endif %}
                    </td>

                    <!-- C·ªòT TRUNG B√åNH -->
                    <td>
                        <strong id="avg_{{ s.id }}">{{ sc.avg if sc.avg else '-' }}</strong>
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>

        <div class="text-end">
            <button type="submit" name="draft" value="1" class="btn btn-secondary">üíæ L∆∞u nh√°p</button>
            <button type="submit" name="save_scores" value="1" class="btn btn-success">‚úÖ L∆∞u ch√≠nh th·ª©c</button>
        </div>
    </form>

    <script src="{{ url_for('static', filename='js/teacher.js') }}"></script>
    {% endif %}
</div>
{% endblock %}
